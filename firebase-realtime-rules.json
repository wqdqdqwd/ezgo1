{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
        ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true || !data.exists())",
        ".validate": "newData.hasChildren(['email', 'full_name']) || auth.token.admin == true",
        
        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/) || auth.token.admin == true"
        },
        
        "full_name": {
          ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 100 || auth.token.admin == true"
        },
        
        "subscription_status": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
          ".validate": "newData.isString() && (newData.val() == 'trial' || newData.val() == 'active' || newData.val() == 'expired') || auth.token.admin == true"
        },
        
        "subscription_expiry": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
          ".validate": "newData.isString() || newData.isNumber() || auth.token.admin == true"
        },
        
        "binance_api_key": {
          ".read": "auth.uid == $uid || auth.token.admin == true",
          ".write": "auth.uid == $uid || auth.token.admin == true"
        },
        
        "binance_api_secret": {
          ".read": "auth.uid == $uid || auth.token.admin == true", 
          ".write": "auth.uid == $uid || auth.token.admin == true"
        },
        
        "api_keys_set": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)"
        },
        
        "bot_active": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)"
        },
        
        "bot_settings": {
          ".read": "auth.uid == $uid || auth.token.admin == true",
          ".write": "auth.uid == $uid || auth.token.admin == true"
        },
        
        "total_trades": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
          ".validate": "newData.isNumber() && newData.val() >= 0 || auth.token.admin == true"
        },
        
        "total_pnl": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
          ".validate": "newData.isNumber() || auth.token.admin == true"
        },
        
        "account_balance": {
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
          ".validate": "newData.isNumber() && newData.val() >= 0 || auth.token.admin == true"
        },
        
        "$other": {
          ".read": "auth != null && (auth.uid == $uid || auth.token.admin == true)",
          ".write": "auth != null && (auth.uid == $uid || auth.token.admin == true)"
        }
      }
    },
    
    "trades": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$tradeId": {
        ".read": "auth != null && (data.child('user_id').val() == auth.uid || auth.token.admin == true)",
        ".write": "auth != null && (data.child('user_id').val() == auth.uid || auth.token.admin == true || !data.exists())",
        ".validate": "newData.hasChildren(['user_id', 'symbol', 'timestamp']) || auth.token.admin == true",
        
        "user_id": {
          ".validate": "newData.isString() && newData.val().length > 0 || auth.token.admin == true"
        },
        
        "symbol": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Z]{3,10}USDT$/) || auth.token.admin == true"
        },
        
        "side": {
          ".validate": "newData.isString() && (newData.val() == 'LONG' || newData.val() == 'SHORT' || newData.val() == 'BUY' || newData.val() == 'SELL') || auth.token.admin == true"
        },
        
        "$other": {
          ".read": "auth != null && (data.parent().child('user_id').val() == auth.uid || auth.token.admin == true)",
          ".write": "auth != null && (data.parent().child('user_id').val() == auth.uid || auth.token.admin == true)"
        }
      }
    },
    
    "payment_notifications": {
      ".read": "auth != null && auth.token.admin == true",
      ".write": "auth != null",
      "$paymentId": {
        ".read": "auth != null && (data.child('user_id').val() == auth.uid || auth.token.admin == true)",
        ".write": "auth != null && (data.child('user_id').val() == auth.uid || auth.token.admin == true || !data.exists())",
        ".validate": "newData.hasChildren(['user_id', 'user_email', 'transaction_hash', 'amount']) || auth.token.admin == true",
        
        "$other": {
          ".read": "auth != null && (data.parent().child('user_id').val() == auth.uid || auth.token.admin == true)",
          ".write": "auth != null && (data.parent().child('user_id').val() == auth.uid || auth.token.admin == true)"
        }
      }
    },
    
    "support_messages": {
      ".read": "auth != null && auth.token.admin == true",
      ".write": "auth != null",
      "$messageId": {
        ".read": "auth != null && (data.child('user_id').val() == auth.uid || auth.token.admin == true)",
        ".write": "auth != null && (data.child('user_id').val() == auth.uid || auth.token.admin == true || !data.exists())",
        ".validate": "newData.hasChildren(['user_id', 'user_email', 'subject', 'message']) || auth.token.admin == true",
        
        "$other": {
          ".read": "auth != null && (data.parent().child('user_id').val() == auth.uid || auth.token.admin == true)",
          ".write": "auth != null && (data.parent().child('user_id').val() == auth.uid || auth.token.admin == true)"
        }
      }
    }
  }
}